"use strict";WPForms.Admin.Builder.Providers.Mailchimp=WPForms.Admin.Builder.Providers.Mailchimp||function(e,i,s){var d={$providerHolder:null,$providerConnections:null,$lock:null,$error:null,config:{templates:["wpforms-mailchimpv3-builder-content-connection","wpforms-mailchimpv3-builder-content-connection-data","wpforms-mailchimpv3-builder-content-connection-subscribe","wpforms-mailchimpv3-builder-content-connection-unsubscribe","wpforms-mailchimpv3-builder-content-connection-archive","wpforms-mailchimpv3-builder-content-connection-delete","wpforms-mailchimpv3-builder-content-connection-record-event","wpforms-mailchimpv3-builder-content-connection-required-fields","wpforms-mailchimpv3-builder-content-connection-error","wpforms-mailchimpv3-builder-content-connection-lock","wpforms-mailchimpv3-builder-content-connection-conditionals"]},replaceConnectionIds:function(n,e){e.find("input, textarea, select, label, .wpforms-panel-field-select").each(function(){var e=s(this);e.attr("name")&&e.attr("name",e.attr("name").replace(/%connection_id%/gi,n)),e.attr("id")&&e.attr("id",e.attr("id").replace(/%connection_id%/gi,n)),e.attr("for")&&e.attr("for",e.attr("for").replace(/%connection_id%/gi,n)),e.attr("data-name")&&e.attr("data-name",e.attr("data-name").replace(/%connection_id%/gi,n))})},connectionAccountExists:function(e,n){return!_.isEmpty(n)&&(!!_.isEmpty(e)||_.has(n,e))}},l={provider:"mailchimpv3",Providers:{},Templates:{},Cache:{},isReady:!1,init:function(){"providers"===wpf.getQueryString("view")&&s("#wpforms-panel-providers").on("WPForms.Admin.Builder.Providers.ready",l.ready),s(e).on("wpformsPanelSwitched",function(e,n){"providers"===n&&l.ready()})},ready:function(){l.isReady||(l.Providers=WPForms.Admin.Builder.Providers,l.Templates=WPForms.Admin.Builder.Templates,l.Cache=l.Providers.cache,d.$providerHolder=l.Providers.getProviderHolder(l.provider),d.$providerConnections=d.$providerHolder.find(".wpforms-builder-provider-connections"),l.Templates.add(d.config.templates),l.Providers.ui.account.registerAddHandler(l.provider,l.processAccountAdd),l.bindUIActions(),l.bindTriggers(),l.processInitial(),l.isReady=!0)},bindUIActions:function(){d.$providerHolder.on("connectionCreate",l.connection.callbacks.create).on("connectionDelete",l.connection.callbacks.delete).on("change",".js-wpforms-builder-mailchimp-provider-connection-account",l.ui.account.changeCallback).on("change",".js-wpforms-builder-mailchimp-provider-connection-lists",l.ui.list.changeCallback).on("change",".js-wpforms-builder-mailchimp-provider-connection-action",l.ui.action.changeCallback).on("change",".js-wpforms-builder-mailchimp-provider-update-profile",l.ui.updateProfile.changeCallback)},bindTriggers:function(){d.$providerConnections.on("connectionsDataLoaded",l.triggers.connectionsDataLoadedHandler).on("connectionGenerated",l.triggers.connectionGeneratedHandler).on("connectionGeneralSettingsRendered",l.triggers.connectionGeneralSettingsRenderedHandler).on("connectionRendered",l.triggers.connectionRenderedHandler),s("#wpforms-builder").on("wpformsSaved",l.requireGDPR.init).on("wpformsFieldDelete",l.triggers.wpformsFieldDeleteHandler),s("#wpforms-field-options").on("change",".wpforms-field-option-name .wpforms-field-option-row-format select",l.triggers.registerTriggerOnNameFormatChange),l.Providers.panelHolder.on("WPForms.Admin.Builder.Providers.updatedMapSelects",l.triggers.updatedMapSelectsHandler)},processInitial:function(){d.$providerConnections.prepend(l.tmpl.callbacks.commonsHTML()),d.$lock=d.$providerConnections.find(".wpforms-builder-provider-connections-save-lock"),d.$error=d.$providerConnections.find(".wpforms-builder-provider-connections-error"),l.connection.callbacks.dataLoad()},processAccountAdd:function(n){if(n.$$add.prop("disabled"))return!1;var e=n.$content.find('input[name="apikey"]'),i=n.$content.find(".error"),o=s.trim(e.val());return n.$$add.prop("disabled",!0),_.isEmpty(o)?(i.show(),n.setType("red"),e.addClass("wpforms-error"),n.$$add.prop("disabled",!1)):(i.hide(),n.setType("blue"),e.removeClass("wpforms-error"),l.Providers.ajax.request(l.provider,{data:{task:"account_save",apikey:o,label:s.trim(n.$content.find('input[name="label"]').val())}}).done(function(e){!e.success||_.has(e.data,"error")&&!_.isEmpty(e.data.error)?(n.setType("red"),n.$$add.prop("disabled",!1),i.html(e.data.error).show()):(d.$providerHolder.find(".wpforms-builder-provider-title-add").toggleClass("hidden"),n.close())})),!1},mapFields:function(e,n){var i=l.Cache.getById(l.provider,"connections",e);_.isEmpty(i)||_.isEmpty(i.fields)||""!==i.fields.EMAIL&&s('select[name="providers['+l.provider+"]["+e+'][fields][EMAIL]"]',n).val(i.fields.EMAIL)},loadChoicesJS:function(e){!_.isFunction(i.Choices)||(e=s(".choicesjs-select",e)).length&&e.each(function(){var e=s(this);_.isUndefined(e.data("choicesjs"))&&e.data("choicesjs",new Choices(this,{shouldSort:!1,removeItemButton:!0,callbackOnInit:function(){var e=this,n=s(e.passedElement.element),i=s(e.input.element);n.prop("multiple")&&(e.getValue(!0).length&&i.addClass(e.config.classNames.input+"--hidden"),n.on("change",function(){e.getValue(!0).length?i.addClass(e.config.classNames.input+"--hidden"):i.removeClass(e.config.classNames.input+"--hidden")}))}}))})},connection:{getById:function(e){return d.$providerConnections.find('.wpforms-builder-provider-connection[data-connection_id="'+e+'"]')},filterFieldsMeta:function(e,n){if(_.isEmpty(e.fields_meta)||!_.isEmpty(e.fields_reqs))return e;var i=[],o=[];return _.each(e.fields_meta,function(e){_.has(e,"name")&&(_.has(n.required,e.name)?o:i).push(e)}),e.fields_meta=i,e.fields_reqs=o,e},callbacks:{create:function(e,n){var i=(new Date).getTime().toString(16),n={isNew:!0,id:i,connection_name:n};l.Cache.addTo(l.provider,"connections",i,n),l.connection.callbacks.generate({connection:n})},delete:function(e,n){n.closest(d.$providerHolder).length&&(n=n.data("connection_id"),_.isUndefined(typeof n)||l.Cache.deleteFrom(l.provider,"connections",n))},generate:function(n){var e=l.Cache.get(l.provider,"accounts");_.isEmpty(e)?l.Providers.ajax.request(l.provider,{data:{task:"accounts_get"}}).done(function(e){e.success&&_.has(e.data,"accounts")?(l.Cache.set(l.provider,"accounts",e.data.accounts),l.connection.callbacks.render(n,e.data.accounts)):l.helpers.showErrorMsg(e.data)}):l.connection.callbacks.render(n,e)},render:function(e,n){var i=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection");d.connectionAccountExists(e.connection.account_id,n)&&(d.$providerConnections.prepend(i({accounts:n,connection:e.connection,provider:l.provider,form_id:l.Providers.form.data("id")})),d.$providerConnections.trigger("connectionGenerated",[e]))},dataLoad:function(){l.Providers.ajax.request(l.provider,{data:{task:"connections_get"}}).done(function(e){e.success&&_.has(e.data,"connections")?(l.Cache.set(l.provider,"connections",jQuery.extend({},e.data.connections)),l.Cache.set(l.provider,"conditionals",jQuery.extend({},e.data.conditionals)),_.isEmpty(e.data.accounts)||l.Cache.set(l.provider,"accounts",jQuery.extend({},e.data.accounts)),d.$providerConnections.trigger("connectionsDataLoaded",[e.data])):l.helpers.showErrorMsg(e.data)})}}},ui:{account:{changeCallback:function(){var e=s(this),n=e.val(),i=e.closest(".wpforms-builder-provider-connection"),o=i.data("connection_id"),r=l.Cache.get(l.provider,"lists");s(".wpforms-builder-mailchimp-provider-connection-data",i).empty(),""!==n?(e.removeClass("wpforms-error"),!_.isEmpty(r)&&_.has(r,n)?l.ui.account.render({account_id:n,connection_id:o}):l.ui.account.request({account_id:n,connection_id:o})):e.addClass("wpforms-error")},request:function(n){l.Providers.ajax.request(l.provider,{data:{task:"objects_get",account_id:n.account_id,connection_id:n.connection_id,sources:{lists:!0}}}).done(function(e){e.success&&!_.isEmpty(e.data)?(_.isUndefined(l.Cache.get(l.provider,"lists"))&&l.Cache.set(l.provider,"lists",{}),l.Cache.addTo(l.provider,"lists",n.account_id,e.data.lists),l.ui.account.render(n)):l.helpers.showErrorMsg(e.data)})},render:function(e){var n=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-data"),i=s("#tmpl-wpforms-"+l.provider+"-builder-content-connection-conditionals").length?l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-conditionals"):l.Templates.get("wpforms-providers-builder-content-connection-conditionals"),o=l.connection.getById(e.connection_id),r=l.Cache.getById(l.provider,"connections",e.connection_id),t=l.Cache.getById(l.provider,"lists",e.account_id),i=_.has(r,"isNew")&&r.isNew?i():l.Cache.getById(l.provider,"conditionals",e.connection_id);r.account_id===e.account_id&&!_.isEmpty(t)||(r={id:r.id}),o.find(".wpforms-builder-mailchimp-provider-connection-data").html(n({lists:l.Cache.getById(l.provider,"lists",e.account_id),connection:r,conditional:i,provider:l.provider})),d.$providerConnections.trigger("connectionGeneralSettingsRendered",[l.provider,e.connection_id])}},list:{changeCallback:function(){var e=s(this),n=e.closest(".wpforms-builder-provider-connection").find(".js-wpforms-builder-mailchimp-provider-connection-action");""===e.val()&&n.prop("selectedIndex",0).trigger("change")}},action:{changeCallback:function(){var e=s(this),n=e.closest(".wpforms-builder-provider-connection"),i=n.data("connection_id"),o=n.find(".js-wpforms-builder-mailchimp-provider-connection-account"),r=n.find(".js-wpforms-builder-mailchimp-provider-connection-lists"),t=e.val();s(".wpforms-builder-mailchimp-provider-actions-data",n).empty(),""!==r.val()?(e.removeClass("wpforms-error"),r.removeClass("wpforms-error"),l.actions.init({action:t,target:e,list_id:r.val(),account_id:o.val(),connection_id:i})):r.addClass("wpforms-error")}},updateProfile:{changeCallback:function(){var e=s(this),n=e.closest(".wpforms-builder-provider-connection").find(".js-wpforms-builder-mailchimp-provider-notify-user");n.closest(".wpforms-builder-provider-connection-setting").toggleClass("wpforms-hidden",e.prop("checked")),e.prop("checked")&&n.prop("checked",!1)}}},triggers:{connectionsDataLoadedHandler:function(e,n){_.each(n.connections,function(e,n){_.isEmpty(e)||l.connection.callbacks.generate({connection:e,conditional:l.Cache.getById(l.provider,"conditionals",n)})})},connectionGeneratedHandler:function(e,n){n=l.connection.getById(n.connection.id),n=s(".js-wpforms-builder-mailchimp-provider-connection-account",n);""!==n.val()&&n.trigger("change")},connectionGeneralSettingsRenderedHandler:function(e,n,i){var o=l.connection.getById(i),r=s(".js-wpforms-builder-mailchimp-provider-connection-action",o);d.replaceConnectionIds(i,o),""!==r.val()&&r.trigger("change")},connectionRenderedHandler:function(e,n,i){var o=l.connection.getById(i);d.replaceConnectionIds(i,o),l.mapFields(i,o),l.loadChoicesJS(o)},updatedMapSelectsHandler:function(e,n,i,o){n=n.filter(".wpforms-builder-mailchimp-provider-connection");_.isEmpty(n)||(l.helpers.updateMapSelects(n,i),o||l.helpers.maybeSaveFormState())},wpformsFieldDeleteHandler:function(e,n,i){!_.isString(i)||"name"!==i||(n=s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value^="'+n+'."]',d.$providerConnections)).length&&n.remove()},registerTriggerOnNameFormatChange:function(e){var n=d.$providerConnections.find(".wpforms-builder-provider-connection");n.length&&l.Providers.panelHolder.trigger("WPForms.Admin.Builder.Providers.updatedMapSelects",[n,wpf.getFields(),!0])}},requireGDPR:{hasErrors:!1,isNotified:!1,init:function(){var e=d.$providerConnections.find(".wpforms-builder-provider-connection"),n=s("#wpforms-panel-fields").find(".wpforms-field-gdpr-checkbox");e.length&&!n.length&&(l.requireGDPR.isNotified=!1,e.each(l.requireGDPR.check))},check:function(){var e=s(this),n=s(".js-wpforms-builder-mailchimp-provider-connection-action",e),i=s(".js-wpforms-builder-mailchimp-provider-connection-lists",e);if(!n.length||!i.length)return!0;if("subscribe"!==n.val())return!0;var o=i.find("option:selected");return!o.data("marketing_permissions")||(l.requireGDPR.hasErrors=!0,setTimeout(function(){l.requireGDPR.notify({connectionName:e.find(".wpforms-builder-provider-connection-name").val(),listName:o.text().trim()})},100),!1)},notify:function(e){var n;_.has(i,"jconfirm")&&!_.isEmpty(i.jconfirm.instances)||l.requireGDPR.hasErrors&&!l.requireGDPR.isNotified&&(n=(n=(n=wpformsMailchimpBuilderVars.i18n.gdpr).replace("{audience}",e.listName)).replace("{connection}",e.connectionName),s.alert({title:wpforms_builder.heads_up,content:n,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}}),l.requireGDPR.isNotified=!0)}},actions:{init:function(e){switch(e.action){case"subscribe":l.actions.subscribe.init(e);break;case"unsubscribe":l.actions.unsubscribe.init(e);break;case"archive":l.actions.archive.init(e);break;case"delete":l.actions.delete.init(e);break;case"record_event":l.actions.recordEvent.init(e)}},subscribe:{init:function(e){for(var n,i=["tags","groups","mergeFields"],o=0;o<i.length;o++)if(n=l.Cache.get(l.provider,i[o]),_.isEmpty(n)||!_.has(n,e.list_id))return void this.request(e);this.render(e)},request:function(n){var i=this;l.Providers.ajax.request(l.provider,{data:{task:"objects_get",list_id:n.list_id,account_id:n.account_id,connection_id:n.connection_id,sources:{tags:!0,groups:!0,mergeFields:!0}}}).done(function(e){e.success&&!_.isEmpty(e.data)?(i.cache(e.data,n),i.render(n)):l.helpers.showErrorMsg(e.data)})},render:function(e){var n=l.helpers.getFieldsForMapping(wpf.getFields()),i=l.Cache.getById(l.provider,"mergeFields",e.list_id),o=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-subscribe"),r=l.Cache.getById(l.provider,"connections",e.connection_id),t=l.connection.getById(e.connection_id),c=!1,r=r.account_id!==e.account_id?{id:r.id}:l.connection.filterFieldsMeta(r,i);t.find(".wpforms-builder-mailchimp-provider-actions-data").html(o({connection:r,tags:l.Cache.getById(l.provider,"tags",e.list_id),groups:l.Cache.getById(l.provider,"groups",e.list_id),provider:l.provider})+l.tmpl.callbacks.optionalFieldsHTML(e,n,i)),_.isObject(i)&&_.isEmpty(i.optional)&&(c=!0,t.find(".wpforms-builder-provider-connection-fields-table tbody").html(""));i=l.tmpl.callbacks.requiredFieldsHTML(r,n,i);_.isEmpty(i)?c&&t.find(".wpforms-builder-provider-connection-fields").remove():t.find(".wpforms-builder-provider-connection-fields-table tbody").prepend(i),d.$providerConnections.trigger("connectionRendered",[l.provider,e.connection_id])},cache:function(n,i){_.each(["tags","groups","mergeFields"],function(e){_.isUndefined(l.Cache.get(l.provider,e))&&l.Cache.set(l.provider,e,{}),_.has(n,e)&&l.Cache.addTo(l.provider,e,i.list_id,n[e])})}},unsubscribe:{init:function(e){this.render(e)},render:function(e){var n=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-unsubscribe");l.connection.getById(e.connection_id).find(".wpforms-builder-mailchimp-provider-actions-data").html(n()),d.$providerConnections.trigger("connectionRendered",[l.provider,e.connection_id])}},archive:{init:function(e){this.render(e)},render:function(e){var n=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-archive");l.connection.getById(e.connection_id).find(".wpforms-builder-mailchimp-provider-actions-data").html(n()),d.$providerConnections.trigger("connectionRendered",[l.provider,e.connection_id])}},delete:{init:function(e){this.render(e)},render:function(e){var n=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-delete");l.connection.getById(e.connection_id).find(".wpforms-builder-mailchimp-provider-actions-data").html(n()),d.$providerConnections.trigger("connectionRendered",[l.provider,e.connection_id])}},recordEvent:{init:function(e){this.render(e)},render:function(e){var n=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-record-event");l.connection.getById(e.connection_id).find(".wpforms-builder-mailchimp-provider-actions-data").html(n({connection:l.Cache.getById(l.provider,"connections",e.connection_id),provider:l.provider})),d.$providerConnections.trigger("connectionRendered",[l.provider,e.connection_id])}}},tmpl:{callbacks:{commonsHTML:function(){var e=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-error"),n=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-lock");return e()+n({provider:l.provider})},optionalFieldsHTML:function(e,n,i){var o=l.Templates.get("wpforms-providers-builder-content-connection-fields"),r=l.Cache.getById(l.provider,"connections",e.connection_id);return _.isObject(i)&&_.has(i,"optional")?o({connection:r=r.account_id!==e.account_id?{id:r.id}:r,fields:n,provider:{slug:l.provider,placeholder:wpformsMailchimpBuilderVars.i18n.providerPlaceholder,fields:i.optional}}):""},requiredFieldsHTML:function(e,n,i){var o=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-required-fields");return _.isObject(i)&&_.has(i,"required")&&!_.isEmpty(i.required)?o({connection:e,fields:n,provider:{slug:l.provider,fields:i.required}}):""}}},helpers:{getFieldsForMapping:function(t){return _.each(t,function(i,e){var o,r;!_.isEmpty(i)&&_.has(i,"id")&&(i.id=i.id.toString(),l.helpers.isNameField(i)&&(o=l.helpers.getFieldLabel(i),delete t[e],_.each(wpformsMailchimpBuilderVars.i18n.nameFieldFormats,function(e,n){(_.has(i,"format")&&-1!==i.format.indexOf(n)||"full"===n)&&(r=i.id+"."+n,t[r]={id:r,label:o+" ("+e+")",format:i.format})})))}),t},getFieldLabel:function(e){var n="";return _.has(e,"id")&&_.has(e,"label")?n=""!==e.label.toString().trim()?wpf.sanitizeHTML(e.label.toString().trim()):wpforms_builder.field+" #"+e.id:n},getNameFormats:function(e){var n=[];return!_.has(e,"format")||_.isEmpty(e.format)?n:(n=e.format.split("-"),_.isArray(n)?n:[])},isNameField:function(e){return!_.isEmpty(e)&&_.has(e,"type")&&"name"===e.type},updateMapSelects:function(o,e){_.each(e,function(e){var n,i;l.helpers.isNameField(e)&&(n=(i=l.helpers.getNameFormats(e)).length,1<i.length&&n++,i=s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-fields-table-row:first option[value^="'+e.id+'."]',o.first()),n&&n===i.length?l.helpers.updateOptionsLabel(s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value^="'+e.id+'."]',o),l.helpers.getFieldLabel(e)):(i.length||(i=s(".wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-fields-table-row:first .wpforms-builder-provider-connection-field-value option",o.first())),l.helpers.updateNameFieldOptions(o,i,e)))})},updateNameFieldOptions:function(r,t,c){var d=l.helpers.getFieldLabel(c),a=c.id;t.filter('[value="'+a+'"]').length||(a=t.last().val()),_.each(wpformsMailchimpBuilderVars.i18n.nameFieldFormats,function(e,n){var i=c.id+"."+n,o=t.filter('[value="'+i+'"]');if(-1!==c.format.indexOf(n)||"full"===n){if(o.length)return a=i,void l.helpers.updateOptionsLabel(o,d);s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+a+'"]',r).after(s("<option>",{text:wpf.sanitizeHTML(d+" ("+e+")"),value:i})),a=i}else o.length&&s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+i+'"]',r).remove()}),s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+c.id+'"]',r).remove()},updateOptionsLabel:function(e,r){_.each(e,function(e){var n=s(e),i=n.val(),o=n.text(),e=i.split("."),i=r;!_.isArray(e)||e.length<2||(e=e[1],_.has(wpformsMailchimpBuilderVars.i18n.nameFieldFormats,e)&&(i+=" ("+wpformsMailchimpBuilderVars.i18n.nameFieldFormats[e]+")"),o!==i&&n.text(i))})},maybeSaveFormState:function(){var e=wpf.getFormState("#wpforms-builder-form");wpf.savedState!==e&&(wpf.savedState=e)},showErrorMsg:function(e){e=_.isEmpty(e.error)?wpformsMailchimpBuilderVars.i18n.generalAjaxError:e.error;d.$lock.val(1),d.$error.html(wpf.sanitizeHTML(e)).show()}}};return l}(document,window,jQuery),WPForms.Admin.Builder.Providers.Mailchimp.init();